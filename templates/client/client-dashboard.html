import React, { useState, useEffect } from 'react';

const ClientDashboard = () => {
  const [user, setUser] = useState({
    username: 'johndoe',
    subscription_level: 'Pro',
    subscription_status: 'Active'
  });
  
  const [scannerStats, setScannerStats] = useState({
    total_scanners: 3,
    total_scans: 42,
    active_scans: 5
  });
  
  const [scanners, setScanners] = useState([
    {
      id: 1,
      scanner_name: "Security Scanner Pro",
      subdomain: "acme.yourscannerdomain.com",
      deploy_status: "deployed",
      deploy_date: "May 3, 2025",
      created_at: "May 3, 2025"
    },
    {
      id: 2,
      scanner_name: "Enterprise Scanner",
      subdomain: "global-innovations.yourscannerdomain.com",
      deploy_status: "deployed",
      deploy_date: "April 28, 2025",
      created_at: "April 28, 2025"
    },
    {
      id: 3,
      scanner_name: "Stellar Security",
      subdomain: "stellar.yourscannerdomain.com",
      deploy_status: "pending",
      deploy_date: "May 2, 2025",
      created_at: "May 2, 2025"
    }
  ]);
  
  const [scanHistory, setScanHistory] = useState([
    {
      scan_id: 1,
      timestamp: "May 5, 2025",
      scanner_name: "Security Scanner Pro",
      target: "acmecorp.com"
    },
    {
      scan_id: 2,
      timestamp: "May 3, 2025",
      scanner_name: "Enterprise Scanner",
      target: "globalinnovations.com"
    },
    {
      scan_id: 3,
      timestamp: "May 1, 2025",
      scanner_name: "Security Scanner Pro",
      target: "acmecorp.com/shop"
    },
    {
      scan_id: 4,
      timestamp: "April 29, 2025",
      scanner_name: "Enterprise Scanner",
      target: "app.globalinnovations.com"
    },
    {
      scan_id: 5,
      timestamp: "April 27, 2025",
      scanner_name: "Security Scanner Pro",
      target: "blog.acmecorp.com"
    }
  ]);
  
  const [showScannerOptionsModal, setShowScannerOptionsModal] = useState(false);
  const [selectedScanner, setSelectedScanner] = useState(null);
  
  const [showRegenerateApiKeyModal, setShowRegenerateApiKeyModal] = useState(false);
  const [isRegenerating, setIsRegenerating] = useState(false);
  const [newApiKey, setNewApiKey] = useState("");
  const [apiKeyRegenerated, setApiKeyRegenerated] = useState(false);
  
  useEffect(() => {
    // Simulate fetching user data, scanner stats, scanners list, and scan history
    // In a real application, these would be API calls
  }, []);
  
  const handleScannerOptions = (scanner) => {
    setSelectedScanner(scanner);
    setShowScannerOptionsModal(true);
  };
  
  const handleRegenerateApiKey = () => {
    setShowScannerOptionsModal(false);
    setShowRegenerateApiKeyModal(true);
  };
  
  const confirmRegenerateApiKey = () => {
    setIsRegenerating(true);
    
    // Simulate API call to regenerate key
    setTimeout(() => {
      setNewApiKey("bd95e8a7-31f2-4d8c-b9a3-7e42f8c91b6d");
      setIsRegenerating(false);
      setApiKeyRegenerated(true);
    }, 1500);
  };
  
  const copyToClipboard = (text, setTempState) => {
    navigator.clipboard.writeText(text).then(() => {
      setTempState(true);
      setTimeout(() => setTempState(false), 2000);
    });
  };
  
  const [copiedNewApiKey, setCopiedNewApiKey] = useState(false);

  return (
    <div className="container-fluid">
      <div className="row">
        {/* Sidebar */}
        <div className="col-md-3 col-lg-2 p-0 sidebar">
          <div className="text-center mb-4">
            <h4>Scanner Platform</h4>
            <p className="mb-0 small">Client Portal</p>
          </div>
          
          <div className="px-3">
            <a href="#" className="sidebar-link active">
              <i className="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="#" className="sidebar-link">
              <i className="bi bi-shield-check"></i> My Scanners
            </a>
            <a href="#" className="sidebar-link">
              <i className="bi bi-file-earmark-text"></i> Scan Reports
            </a>
            <a href="#" className="sidebar-link">
              <i className="bi bi-gear"></i> Settings
            </a>
            
            <hr className="my-4" />
            
            <a href="#" className="sidebar-link text-danger">
              <i className="bi bi-box-arrow-right"></i> Logout
            </a>
          </div>
        </div>
        
        {/* Main Content */}
        <div className="col-md-9 col-lg-10 ms-auto main-content">
          <div className="d-flex justify-content-between align-items-center mb-4">
            <h2>Client Dashboard</h2>
            <div>
              <span className="badge bg-primary">Client</span>
              <span className="ms-2">{user.username}</span>
            </div>
          </div>
          
          {/* Stats Overview */}
          <div className="row g-4 mb-4">
            <div className="col-md-4">
              <div className="card stat-card border-0 shadow-sm">
                <div className="card-body">
                  <div className="d-flex align-items-center mb-3">
                    <div className="icon-circle me-3 bg-primary bg-opacity-10">
                      <i className="bi bi-shield-check text-primary"></i>
                    </div>
                    <h6 className="mb-0">My Scanners</h6>
                  </div>
                  <div className="stat-value">{scannerStats.total_scanners}</div>
                  <p className="text-muted mb-0">Total deployed scanners</p>
                </div>
              </div>
            </div>
            
            <div className="col-md-4">
              <div className="card stat-card border-0 shadow-sm">
                <div className="card-body">
                  <div className="d-flex align-items-center mb-3">
                    <div className="icon-circle me-3 bg-success bg-opacity-10">
                      <i className="bi bi-search text-success"></i>
                    </div>
                    <h6 className="mb-0">Total Scans</h6>
                  </div>
                  <div className="stat-value">{scannerStats.total_scans}</div>
                  <p className="text-muted mb-0">Scans conducted to date</p>
                </div>
              </div>
            </div>
            
            <div className="col-md-4">
              <div className="card stat-card border-0 shadow-sm">
                <div className="card-body">
                  <div className="d-flex align-items-center mb-3">
                    <div className="icon-circle me-3 bg-warning bg-opacity-10">
                      <i className="bi bi-calendar-check text-warning"></i>
                    </div>
                    <h6 className="mb-0">Subscription</h6>
                  </div>
                  <div className="d-flex align-items-center">
                    <div>
                      <h5 className="mb-0">{user.subscription_level}</h5>
                      <p className="text-muted mb-0">{user.subscription_status}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {/* My Scanners Section */}
          <div className="card border-0 shadow-sm mb-4">
            <div className="card-header d-flex justify-content-between align-items-center bg-white">
              <h5 className="mb-0">My Scanners</h5>
              <a href="#" className="btn btn-sm btn-outline-primary">Create New Scanner</a>
            </div>
            <div className="card-body p-0">
              <div className="table-responsive">
                <table className="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Scanner Name</th>
                      <th>Domain</th>
                      <th>Status</th>
                      <th>Created</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {scanners.length > 0 ? (
                      scanners.map((scanner) => (
                        <tr key={scanner.id}>
                          <td>
                            <strong>{scanner.scanner_name}</strong>
                          </td>
                          <td>
                            <a href={`https://${scanner.subdomain}`} target="_blank" rel="noreferrer">
                              {scanner.subdomain}
                            </a>
                          </td>
                          <td>
                            <span className={`status-badge ${scanner.deploy_status === 'deployed' ? 'status-deployed' : scanner.deploy_status === 'pending' ? 'status-pending' : 'status-inactive'}`}>
                              {scanner.deploy_status.charAt(0).toUpperCase() + scanner.deploy_status.slice(1)}
                            </span>
                          </td>
                          <td>{scanner.deploy_date || scanner.created_at}</td>
                          <td>
                            <div className="d-flex">
                              <a href={`#/scanners/${scanner.id}/view`} className="scanner-action" title="View Scanner">
                                <i className="bi bi-eye"></i>
                              </a>
                              <a href={`#/scanners/${scanner.id}/edit`} className="scanner-action" title="Edit Scanner">
                                <i className="bi bi-pencil"></i>
                              </a>
                              <a href={`#/scanners/${scanner.id}/stats`} className="scanner-action" title="Scanner Stats">
                                <i className="bi bi-graph-up"></i>
                              </a>
                              <button 
                                className="scanner-action" 
                                title="More Options"
                                onClick={() => handleScannerOptions(scanner)}
                              >
                                <i className="bi bi-three-dots-vertical"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="5" className="text-center py-4">
                          <div className="text-muted">
                            <i className="bi bi-search fs-3 d-block mb-3"></i>
                            No scanners found. 
                            <a href="#" className="text-primary">Create your first scanner</a>
                          </div>
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          {/* Recent Scan Activity */}
          <div className="card border-0 shadow-sm">
            <div className="card-header bg-white">
              <h5 className="mb-0">Recent Scan Activity</h5>
            </div>
            <div className="card-body p-0">
              <div className="table-responsive">
                <table className="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Scanner</th>
                      <th>Target</th>
                      <th>Report</th>
                    </tr>
                  </thead>
                  <tbody>
                    {scanHistory.length > 0 ? (
                      scanHistory.map((scan) => (
                        <tr key={scan.scan_id}>
                          <td>{scan.timestamp}</td>
                          <td>{scan.scanner_name}</td>
                          <td>{scan.target}</td>
                          <td>
                            <a href={`#/reports/${scan.scan_id}`} className="btn btn-sm btn-outline-primary">
                              <i className="bi bi-file-earmark-text me-1"></i> View Report
                            </a>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="4" className="text-center py-4">
                          <div className="text-muted">
                            <i className="bi bi-clipboard-check fs-3 d-block mb-3"></i>
                            No scan history found.
                          </div>
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Scanner Options Modal */}
      {showScannerOptionsModal && selectedScanner && (
        <div className="modal fade show" style={{ display: 'block', backgroundColor: 'rgba(0,0,0,0.5)' }} tabIndex="-1">
          <div className="modal-dialog">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">Scanner Options</h5>
                <button type="button" className="btn-close" onClick={() => setShowScannerOptionsModal(false)}></button>
              </div>
              <div className="modal-body">
                <div className="list-group">
                  <a href={`#/scanners/${selectedScanner.id}/view`} className="list-group-item list-group-item-action">
                    <i className="bi bi-eye me-2"></i> View Scanner Interface
                  </a>
                  <a href={`#/scanners/${selectedScanner.id}/edit`} className="list-group-item list-group-item-action">
                    <i className="bi bi-pencil me-2"></i> Edit Scanner Configuration
                  </a>
                  <a href="#" className="list-group-item list-group-item-action" onClick={handleRegenerateApiKey}>
                    <i className="bi bi-key me-2"></i> Regenerate API Key
                  </a>
                  <a href={`#/scanners/${selectedScanner.id}/stats`} className="list-group-item list-group-item-action">
                    <i className="bi bi-clock-history me-2"></i> View Scan History
                  </a>
                </div>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-secondary" onClick={() => setShowScannerOptionsModal(false)}>Close</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* API Key Regeneration Modal */}
      {showRegenerateApiKeyModal && (
        <div className="modal fade show" style={{ display: 'block', backgroundColor: 'rgba(0,0,0,0.5)' }} tabIndex="-1">
          <div className="modal-dialog">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">Regenerate API Key</h5>
                <button type="button" className="btn-close" onClick={() => setShowRegenerateApiKeyModal(false)}></button>
              </div>
              <div className="modal-body">
                <div className="alert alert-warning">
                  <i className="bi bi-exclamation-triangle-fill me-2"></i>
                  <strong>Warning:</strong> Regenerating the API key will invalidate the previous key. Any applications or services using the old key will need to be updated.
                </div>
                <p>Are you sure you want to regenerate the API key for this scanner?</p>
                {apiKeyRegenerated && (
                  <div className="mt-3">
                    <div className="alert alert-success">
                      <p className="mb-2"><strong>New API Key:</strong></p>
                      <div className="input-group mb-2">
                        <input type="text" value={newApiKey} className="form-control" readOnly />
                        <button 
                          className="btn btn-outline-secondary" 
                          type="button"
                          onClick={() => copyToClipboard(newApiKey, setCopiedNewApiKey)}
                        >
                          {copiedNewApiKey ? (
                            <i className="bi bi-check"></i>
                          ) : (
                            <i className="bi bi-clipboard"></i>
                          )}
                        </button>
                      </div>
                      <p className="small text-muted mb-0">Please save this key in a secure location. It will not be shown again.</p>
                    </div>
                  </div>
                )}
              </div>
              <div className="modal-footer">
                <button 
                  type="button" 
                  className="btn btn-secondary" 
                  onClick={() => setShowRegenerateApiKeyModal(false)}
                  disabled={isRegenerating}
                >
                  {apiKeyRegenerated ? 'Close' : 'Cancel'}
                </button>
                {!apiKeyRegenerated && (
                  <button 
                    type="button" 
                    className="btn btn-danger" 
                    onClick={confirmRegenerateApiKey}
                    disabled={isRegenerating}
                  >
                    {isRegenerating ? (
                      <>
                        <span className="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...
                      </>
                    ) : (
                      'Regenerate API Key'
                    )}
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default ClientDashboard;
